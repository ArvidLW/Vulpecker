--- content/html/document/src/nsHTMLDocument.cpp	16 Jun 2005 13:10:53 -0000	3.609
+++ content/html/document/src/nsHTMLDocument.cpp	18 Jun 2005 06:42:04 -0000
@@ -1820,33 +1820,18 @@ nsHTMLDocument::SetCookie(const nsAStrin
     }
 
     NS_LossyConvertUTF16toASCII cookie(aCookie);
     service->SetCookieString(codebaseURI, prompt, cookie.get(), mChannel);
   }
 
   return NS_OK;
 }
 
-// static
-nsIPrincipal *
-nsHTMLDocument::GetCallerPrincipal()
-{
-  // XXX This will fail on non-DOM contexts :(
-  nsIDOMDocument *domDoc = nsContentUtils::GetDocumentFromCaller();
-
-  nsCOMPtr<nsIDocument> doc(do_QueryInterface(domDoc));
-  if (!doc) {
-    return nsnull; // No document in the window
-  }
-
-  return doc->GetPrincipal();
-}
-
 // XXX TBI: accepting arguments to the open method.
 nsresult
 nsHTMLDocument::OpenCommon(const nsACString& aContentType, PRBool aReplace)
 {
   // If we already have a parser we ignore the document.open call.
   if (mParser) {
     if (IsXHTML()) {
       // No calling document.open() while we're parsing XHTML
 
@@ -1862,19 +1847,21 @@ nsHTMLDocument::OpenCommon(const nsACStr
     do_QueryInterface(nsContentUtils::GetDocumentFromCaller());
 
   // Grab a reference to the calling documents security info (if any)
   // and principal as it may be lost in the call to Reset().
   nsCOMPtr<nsISupports> securityInfo;
   nsCOMPtr<nsIPrincipal> callerPrincipal;
 
   if (callerDoc) {
     securityInfo = callerDoc->GetSecurityInfo();
-    callerPrincipal = GetCallerPrincipal();
+
+    nsContentUtils::GetSecurityManager()->
+      GetSubjectPrincipal(getter_AddRefs(callerPrincipal));
   }
 
   // The URI for the document after this call. Get it from the calling
   // principal (if available), or set it to "about:blank" if no
   // principal is reachable.
   nsCOMPtr<nsIURI> uri;
 
   if (callerPrincipal) {
     callerPrincipal->GetURI(getter_AddRefs(uri));

--- content/html/document/src/nsHTMLDocument.h	7 Jun 2005 19:21:05 -0000	3.181
+++ content/html/document/src/nsHTMLDocument.h	18 Jun 2005 06:42:04 -0000
@@ -223,20 +223,18 @@ protected:
   nsIContent *MatchId(nsIContent *aContent, const nsAString& aId);
 
   static PRBool MatchLinks(nsIContent *aContent, PRInt32 aNamespaceID,
                            nsIAtom* aAtom, const nsAString& aData);
   static PRBool MatchAnchors(nsIContent *aContent, PRInt32 aNamespaceID,
                              nsIAtom* aAtom, const nsAString& aData);
   static PRBool MatchNameAttribute(nsIContent* aContent, PRInt32 aNamespaceID,
                                    nsIAtom* aAtom, const nsAString& aData);
 
-  static nsIPrincipal *GetCallerPrincipal();
-
   static void DocumentWriteTerminationFunc(nsISupports *aRef);
 
   PRBool GetBodyContent();
   void GetBodyElement(nsIDOMHTMLBodyElement** aBody);
 
   void GetDomainURI(nsIURI **uri);
 
   nsresult WriteCommon(const nsAString& aText,
                        PRBool aNewlineTerminate);
