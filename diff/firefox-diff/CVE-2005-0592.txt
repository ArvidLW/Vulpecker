--- xpcom/string/src/nsReadableUtils.cpp	24 Jan 2005 16:44:41 -0000	1.61
+++ xpcom/string/src/nsReadableUtils.cpp	12 Feb 2005 23:44:09 -0000
@@ -390,32 +390,37 @@ NS_COM
 PRUnichar*
 UTF8ToNewUnicode( const nsACString& aSource, PRUint32 *aUTF16Count )
   {
     nsACString::const_iterator start, end;
     CalculateUTF8Length calculator;
     copy_string(aSource.BeginReading(start), aSource.EndReading(end),
                 calculator);
 
     if (aUTF16Count)
       *aUTF16Count = calculator.Length();
 
     PRUnichar *result = NS_STATIC_CAST(PRUnichar*,
         nsMemory::Alloc(sizeof(PRUnichar) * (calculator.Length() + 1)));
 
-    ConvertUTF8toUTF16 converter(result);
-    copy_string(aSource.BeginReading(start), aSource.EndReading(end),
-                converter).write_terminator();
-    NS_ASSERTION(calculator.Length() == converter.Length(), "length mismatch");
+    if (calculator.Length() > 0)
+      {
+        ConvertUTF8toUTF16 converter(result);
+        copy_string(aSource.BeginReading(start), aSource.EndReading(end),
+                    converter).write_terminator();
+        NS_ASSERTION(calculator.Length() == converter.Length(), "length mismatch");
+      }
+    else
+      *result = PRUnichar('\0');
 
     return result;
   }
 
 NS_COM
 PRUnichar*
 CopyUnicodeTo( const nsAString& aSource, PRUint32 aSrcOffset, PRUnichar* aDest, PRUint32 aLength )
   {
     nsAString::const_iterator fromBegin, fromEnd;
     PRUnichar* toBegin = aDest;    
     copy_string(aSource.BeginReading(fromBegin).advance( PRInt32(aSrcOffset) ), aSource.BeginReading(fromEnd).advance( PRInt32(aSrcOffset+aLength) ), toBegin);
     return aDest;
   }
 
