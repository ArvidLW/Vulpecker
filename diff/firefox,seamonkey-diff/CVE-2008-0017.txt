--- netwerk/streamconv/converters/nsDirIndexParser.cpp	22 Jun 2006 19:13:01 -0000	1.18.16.1
+++ netwerk/streamconv/converters/nsDirIndexParser.cpp	27 Aug 2008 19:19:47 -0000
@@ -185,26 +185,33 @@ nsDirIndexParser::ParseFormat(const char
   // easier to do this then realloc
   const char* pos = aFormatStr;
   int num = 0;
   do {
     while (*pos && nsCRT::IsAsciiSpace(PRUnichar(*pos)))
       ++pos;
     
     ++num;
+    // There are a maximum of six allowed header fields (doubled plus
+    // terminator, just in case) -- Bug 443299
+    if (num > (2 * NS_ARRAY_LENGTH(gFieldTable)))
+      return NS_ERROR_UNEXPECTED;
 
     if (! *pos)
       break;
 
     while (*pos && !nsCRT::IsAsciiSpace(PRUnichar(*pos)))
       ++pos;
 
   } while (*pos);
 
   mFormat = new int[num+1];
+  // Prevent NULL Deref - Bug 443299 
+  if (mFormat == nsnull)
+    return NS_ERROR_OUT_OF_MEMORY;
   mFormat[num] = -1;
   
   int formatNum=0;
   do {
     while (*aFormatStr && nsCRT::IsAsciiSpace(PRUnichar(*aFormatStr)))
       ++aFormatStr;
     
     if (! *aFormatStr)
