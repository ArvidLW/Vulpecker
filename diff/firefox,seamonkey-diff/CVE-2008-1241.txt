--- layout/generic/nsFrameFrame.cpp	24 Feb 2006 04:58:47 -0000	3.285.6.2
+++ layout/generic/nsFrameFrame.cpp	7 Feb 2008 18:47:35 -0000
@@ -518,16 +518,30 @@ nsSubDocumentFrame::AttributeChanged(nsI
     nsCOMPtr<nsIDocShellTreeOwner> parentTreeOwner;
     parentItem->GetTreeOwner(getter_AddRefs(parentTreeOwner));
     if (parentTreeOwner) {
       nsAutoString value;
       mContent->GetAttr(kNameSpaceID_None, nsHTMLAtoms::type, value);
 
       PRBool is_primary = value.LowerCaseEqualsLiteral("content-primary");
 
+      // when a content panel is no longer primary, hide any open popups it may have
+      if (!is_primary) {
+        nsCOMPtr<nsIDocShell> docShell;
+        GetDocShell(getter_AddRefs(docShell));
+        if (docShell) {
+          nsCOMPtr<nsIPresShell> presShell;
+          docShell->GetPresShell(getter_AddRefs(presShell));
+
+          nsCOMPtr<nsIPresShell_MOZILLA_1_8_BRANCH> presShell18 = do_QueryInterface(presShell);
+          if (presShell18)
+            presShell18->HidePopups();
+        }
+      }
+
       nsCOMPtr<nsIDocShellTreeOwner_MOZILLA_1_8_BRANCH> owner2 =
         do_QueryInterface(parentTreeOwner);
 
       if (!owner2) {
         // XXXbz this adds stuff even if it's not of type content-*, but not
         // much we can do about that....
         parentTreeOwner->ContentShellAdded(docShellAsItem, is_primary,
                                            value.get());
