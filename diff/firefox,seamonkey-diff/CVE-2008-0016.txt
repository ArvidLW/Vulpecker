--- netwerk/dns/src/nsIDNService.cpp	22 Jul 2005 15:07:33 -0000	1.28
+++ netwerk/dns/src/nsIDNService.cpp	18 Aug 2008 21:27:29 -0000
@@ -145,18 +145,21 @@ nsIDNService::nsIDNService()
 
 nsIDNService::~nsIDNService()
 {
   idn_nameprep_destroy(mNamePrepHandle);
 }
 
 /* ACString ConvertUTF8toACE (in AUTF8String input); */
 NS_IMETHODIMP nsIDNService::ConvertUTF8toACE(const nsACString & input, nsACString & ace)
 {
+  // protect against bogus input
+  NS_ENSURE_TRUE(IsUTF8(input), NS_ERROR_UNEXPECTED);
+
   nsresult rv;
   NS_ConvertUTF8toUCS2 ustr(input);
 
   // map ideographic period to ASCII period etc.
   normalizeFullStops(ustr);
 
 
   PRUint32 len, offset;
   len = 0;
