--- tm.orig/js/src/jsinterp.cpp	2009-03-23 19:50:10.000000000 +0100
+++ tm/js/src/jsinterp.cpp	2009-03-23 19:56:58.000000000 +0100
@@ -164,17 +164,23 @@ js_FillPropertyCache(JSContext *cx, JSOb
     if (protoIndex != 0) {
         JSObject *tmp;
 
         JS_ASSERT(pobj != obj);
         protoIndex = 1;
         tmp = obj;
         for (;;) {
             tmp = OBJ_GET_PROTO(cx, tmp);
-            if (!tmp) {
+
+            /*
+             * We cannot cache properties coming from native objects behind
+             * non-native ones on the prototype chain. The non-natives can
+             * mutate in arbitrary way without changing any shapes.
+             */
+            if (!tmp || !OBJ_IS_NATIVE(tmp)) {
                 PCMETER(cache->noprotos++);
                 *entryp = NULL;
                 return;
             }
             if (tmp == pobj)
                 break;
             ++protoIndex;
         }
