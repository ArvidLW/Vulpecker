--- jsregexp.c	30 Jul 2006 18:42:19 -0000	3.123
+++ jsregexp.c	1 Aug 2006 07:58:25 -0000
@@ -1331,21 +1331,23 @@ doSimple:
                 js_ReportCompileErrorNumberUC(state->context, state->tokenStream,
                                               JSREPORT_TS | JSREPORT_ERROR,
                                               JSMSG_UNTERM_CLASS, termStart);
 
                 return JS_FALSE;
             }
             if (*state->cp == '\\') {
                 state->cp++;
-            } else {
-                if (*state->cp == ']') {
-                    state->result->u.ucclass.kidlen = state->cp - termStart;
-                    break;
-                }
+                if (state->cp != state->cpend)
+                    state->cp++;
+                continue;
+            }
+            if (*state->cp == ']') {
+                state->result->u.ucclass.kidlen = state->cp - termStart;
+                break;
             }
             state->cp++;
         }
         for (i = 0; i < CLASS_CACHE_SIZE; i++) {
             if (!state->classCache[i].start) {
                 state->classCache[i].start = termStart;
                 state->classCache[i].length = state->result->u.ucclass.kidlen;
                 state->classCache[i].index = state->classCount;
