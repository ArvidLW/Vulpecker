--- layout/printing/nsPrintEngine.cpp	3 Feb 2006 14:17:57 -0000	1.111
+++ layout/printing/nsPrintEngine.cpp	6 Feb 2006 05:05:49 -0000
@@ -2509,56 +2509,16 @@ nsPrintEngine::ReflowDocList(nsPrintObje
   for (PRInt32 i=0;i<cnt;i++) {
     if (NS_FAILED(ReflowDocList((nsPrintObject *)aPO->mKids[i], aSetPixelScale, aDoCalcShrink))) {
       return NS_ERROR_FAILURE;
     }
   }
   return NS_OK;
 }
 
-PR_STATIC_CALLBACK(void *)
-HandleBarrierEvent(PLEvent *aEvent)
-{
-  PRBool *b = NS_STATIC_CAST(PRBool *, PL_GetEventOwner(aEvent));
-  *b = PR_TRUE;
-  return nsnull;
-}
-
-PR_STATIC_CALLBACK(void)
-DestroyBarrierEvent(PLEvent *aEvent)
-{
-}
-
-static void
-FlushEventQueue()
-{
-  PRBool hitBarrier = PR_FALSE;
-  nsCOMPtr<nsIEventQueue> eventQ;
-  nsresult rv = NS_GetMainEventQ(getter_AddRefs(eventQ));
-  if (NS_FAILED(rv))
-    return;
-
-  PLEvent evt;
-
-  PL_InitEvent(&evt, &hitBarrier, HandleBarrierEvent, DestroyBarrierEvent);
-
-  if (NS_FAILED(eventQ->PostEvent(&evt)))
-    return;
-
-  while (!hitBarrier) {
-    PLEvent *next;
-    eventQ->GetEvent(&next);
-    if (!next) {
-      NS_ERROR("barrier event not found!");
-      return;
-    }
-    eventQ->HandleEvent(next);
-  }
-}
-
 //-------------------------------------------------------
 // Reflow a nsPrintObject
 nsresult
 nsPrintEngine::ReflowPrintObject(nsPrintObject * aPO, PRBool aDoCalcShrink)
 {
   NS_ASSERTION(aPO, "Pointer is null!");
   if (!aPO) return NS_ERROR_FAILURE;
 
@@ -2763,17 +2723,16 @@ nsPrintEngine::ReflowPrintObject(nsPrint
   if (!adjRect.width || !adjRect.height || !width || !height) {
     aPO->mDontPrint = PR_TRUE;
     aPO->mPresShell->EndObservingDocument();
     return NS_OK;
   }
 
   aPO->mPresContext->SetPageDim(adjRect);
   rv = aPO->mPresShell->InitialReflow(width, height);
-  FlushEventQueue();
   if (NS_SUCCEEDED(rv)) {
     // Transfer Selection Ranges to the new Print PresShell
     nsCOMPtr<nsISelection> selection;
     nsCOMPtr<nsISelection> selectionPS;
     nsresult rvv = mDocViewerPrint->GetDocumentSelection(getter_AddRefs(selection), aPO->mDisplayPresShell);
     if (NS_SUCCEEDED(rvv) && selection) {
       rvv = mDocViewerPrint->GetDocumentSelection(getter_AddRefs(selectionPS), aPO->mPresShell);
       if (NS_SUCCEEDED(rvv) && selectionPS) {

--- caps/src/nsScriptSecurityManager.cpp	3 Feb 2006 14:17:31 -0000	1.283
+++ caps/src/nsScriptSecurityManager.cpp	6 Feb 2006 05:28:17 -0000
@@ -1553,16 +1553,23 @@ nsScriptSecurityManager::CanExecuteScrip
         // Even if JavaScript is disabled, we must still execute system scripts
         *result = PR_TRUE;
         return NS_OK;
     }
 
     //-- See if the current window allows JS execution
     nsIScriptContext *scriptContext = GetScriptContext(cx);
     if (!scriptContext) return NS_ERROR_FAILURE;
+
+    if (!scriptContext->GetScriptsEnabled()) {
+        // No scripting on this context, folks
+        *result = PR_FALSE;
+        return NS_OK;
+    }
+    
     nsIScriptGlobalObject *sgo = scriptContext->GetGlobalObject();
 
     if (!sgo) {
         return NS_ERROR_FAILURE;
     }
 
     // window can be null here if we're running with a non-DOM window
     // as the script global (i.e. a XUL prototype document).
