--- intl/uconv/ucvja/nsJapaneseToUnicode.cpp	6 Sep 2007 05:02:17 -0000	1.30
+++ intl/uconv/ucvja/nsJapaneseToUnicode.cpp	3 Dec 2007 21:05:23 -0000
@@ -531,21 +531,28 @@ NS_IMETHODIMP nsISO2022JPToUnicodeV2::Co
               mState = mLastLegalState;
             }
           break;
 
           case mState_ESC_28: // ESC (
             if( 'B' == *src) {
               mState = mState_ASCII;
               if (mRunLength == 0) {
-                goto error2;
+                if((dest+1) >= destEnd)
+                  goto error1;
+                *dest++ = 0xFFFD;
               }
               mRunLength = 0;
             } else if ('J' == *src)  {
               mState = mState_JISX0201_1976Roman;
+              if (mRunLength == 0 && mLastLegalState != mState_ASCII) {
+                if((dest+1) >= destEnd)
+                  goto error1;
+                *dest++ = 0xFFFD;
+              }
               mRunLength = 0;
             } else if ('I' == *src)  {
               mState = mState_JISX0201_1976Kana;
               mRunLength = 0;
             } else  {
               if((dest+3) >= destEnd)
                 goto error1;
               *dest++ = (PRUnichar) 0x1b;
