--- mozilla/nsprpub/lib/libc/src/base64.c	25 Apr 2004 15:00:36 -0000	3.7
+++ mozilla/nsprpub/lib/libc/src/base64.c	15 May 2009 15:56:55 -0000
@@ -150,17 +150,23 @@ PL_Base64Encode
 {
     if( 0 == srclen )
     {
         srclen = PL_strlen(src);
     }
 
     if( (char *)0 == dest )
     {
-        PRUint32 destlen = ((srclen + 2)/3) * 4;
+        PRUint32 destlen;
+        /* Ensure all PRUint32 values stay within range. */
+        if( srclen > (PR_UINT32_MAX/4) * 3 )
+        {
+            return (char *)0;
+        }
+        destlen = ((srclen + 2)/3) * 4;
         dest = (char *)PR_MALLOC(destlen + 1);
         if( (char *)0 == dest )
         {
             return (char *)0;
         }
         dest[ destlen ] = (char)0; /* null terminate */
     }
 
@@ -398,17 +404,19 @@ PL_Base64Decode
             {
                 srclen -= 1;
             }
         }
     }
 
     if( (char *)0 == dest )
     {
-        PRUint32 destlen = ((srclen * 3) / 4);
+        /* The following computes ((srclen * 3) / 4) without overflow. */
+        PRUint32 rem = srclen % 4;
+        PRUint32 destlen = (srclen / 4) * 3 + (rem * 3) / 4;
         dest = (char *)PR_MALLOC(destlen + 1);
         if( (char *)0 == dest )
         {
             return (char *)0;
         }
         dest[ destlen ] = (char)0; /* null terminate */
         allocated = PR_TRUE;
     }