--- nsTreeColFrame.cpp	15 Aug 2007 08:20:12 -0000	1.51
+++ nsTreeColFrame.cpp	19 Nov 2007 23:55:53 -0000
@@ -40,16 +40,17 @@
 #include "nsTreeColFrame.h"
 #include "nsGkAtoms.h"
 #include "nsIContent.h"
 #include "nsStyleContext.h"
 #include "nsINameSpaceManager.h" 
 #include "nsIDOMNSDocument.h"
 #include "nsIDocument.h"
 #include "nsIBoxObject.h"
+#include "nsTreeBoxObject.h"
 #include "nsIDOMElement.h"
 #include "nsITreeBoxObject.h"
 #include "nsITreeColumns.h"
 #include "nsIDOMXULTreeElement.h"
 #include "nsDisplayList.h"
 
 //
 // NS_NewTreeColFrame
@@ -94,17 +95,17 @@ nsTreeColFrame::Init(nsIContent*      aC
   nsresult rv = nsBoxFrame::Init(aContent, aParent, aPrevInFlow);
   InvalidateColumns();
   return rv;
 }
 
 void                                                                
 nsTreeColFrame::Destroy()                          
 {
-  InvalidateColumns();
+  InvalidateColumns(PR_FALSE);
   nsBoxFrame::Destroy();
 }
 
 class nsDisplayXULTreeColSplitterTarget : public nsDisplayItem {
 public:
   nsDisplayXULTreeColSplitterTarget(nsIFrame* aFrame) : nsDisplayItem(aFrame) {
     MOZ_COUNT_CTOR(nsDisplayXULTreeColSplitterTarget);
   }
@@ -215,19 +216,28 @@ nsTreeColFrame::GetTreeBoxObject()
       nsCOMPtr<nsITreeBoxObject> treeBoxObject = do_QueryInterface(boxObject);
       result = treeBoxObject.get();
     }
   }
   return result;
 }
 
 void
-nsTreeColFrame::InvalidateColumns()
+nsTreeColFrame::InvalidateColumns(PRBool aCanWalkFrameTree)
 {
   nsITreeBoxObject* treeBoxObject = GetTreeBoxObject();
   if (treeBoxObject) {
     nsCOMPtr<nsITreeColumns> columns;
-    treeBoxObject->GetColumns(getter_AddRefs(columns));
+
+    if (aCanWalkFrameTree) {
+      treeBoxObject->GetColumns(getter_AddRefs(columns));
+    } else {
+      nsITreeBoxObject* body =
+        static_cast<nsTreeBoxObject*>(treeBoxObject)->GetCachedTreeBody();
+      if (body) {
+        body->GetColumns(getter_AddRefs(columns));
+      }
+    }
 
     if (columns)
       columns->InvalidateColumns();
   }
 }

--- nsTreeColFrame.h	22 Feb 2007 18:05:14 -0000	1.30
+++ nsTreeColFrame.h	19 Nov 2007 23:55:53 -0000
@@ -84,10 +84,10 @@ protected:
    * @return the tree box object of the tree this column belongs to, or nsnull.
    */
   nsITreeBoxObject* GetTreeBoxObject();
 
   /**
    * Helper method that gets the nsITreeColumns object this column belongs to
    * and calls InvalidateColumns() on it.
    */
-  void InvalidateColumns();
+  void InvalidateColumns(PRBool aCanWalkFrameTree = PR_TRUE);
 };
